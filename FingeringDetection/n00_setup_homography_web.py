#!/usr/bin/env python3
"""
Ïõπ Î∏åÎùºÏö∞Ï†Ä Í∏∞Î∞ò ÌîΩÏÖÄ Ï¢åÌëú ÏàòÏßë ÎèÑÍµ¨
ÏÑúÎ≤Ñ ÌôòÍ≤ΩÏóêÏÑú SSHÎ•º ÌÜµÌï¥ Ï†ëÏÜçÌïòÏó¨ ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§.
"""

import os
import cv2
import numpy as np
import json
from pathlib import Path
import argparse
from flask import Flask, render_template_string, request, jsonify
import base64
from io import BytesIO

app = Flask(__name__)

class PixelCoordinateCollector:
    def __init__(self, output_dir="./data/pixel_points"):
        self.output_dir = Path(output_dir)
        self.output_dir.mkdir(parents=True, exist_ok=True)
        
        # ÌòÑÏû¨ Ï≤òÎ¶¨ Ï§ëÏù∏ Î≥ÄÏàòÎì§
        self.current_video_files = []
        self.current_video_index = 0
        
        # ÌòÑÏû¨ ÏÑ†ÌÉùÎêú guide Ïù¥ÎØ∏ÏßÄ
        self.current_guide = "guide1"  # Í∏∞Î≥∏Í∞í
        
    def find_video_files(self, video_dir):
        """ÎπÑÎîîÏò§ ÌååÏùºÎì§ÏùÑ Ï∞æÏäµÎãàÎã§."""
        video_dir = Path(video_dir)
        video_extensions = ['.mp4', '.avi', '.mov', '.mkv', '.wmv']
        video_files = []
        
        for ext in video_extensions:
            video_files.extend(video_dir.glob(f'*{ext}'))
            video_files.extend(video_dir.glob(f'*{ext.upper()}'))
        
        self.current_video_files = sorted(video_files)
        self.current_video_index = 0
        
        return len(self.current_video_files)
    
    def get_guide_path(self):
        """ÌòÑÏû¨ ÏÑ†ÌÉùÎêú guide Ïù¥ÎØ∏ÏßÄ Í≤ΩÎ°ú Î∞òÌôò"""
        return f"/home/jhbae/pianomime/data/{self.current_guide}.png"

# Ï†ÑÏó≠ ÏÑ§Ï†ï Í∞ùÏ≤¥
pixel_collector = None

# HTML ÌÖúÌîåÎ¶ø
HTML_TEMPLATE = '''
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Pixel Coordinate Collector</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 10px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh;
        }
        .container { 
            width: 100%; 
            margin: 0; 
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            overflow: hidden;
            display: grid;
            grid-template-rows: auto auto 1fr auto;
            min-height: calc(100vh - 20px);
        }
        .app-bar { 
            background: linear-gradient(45deg, #1e3c72, #2a5298); 
            color: white; 
            padding: 15px 20px; 
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .app-bar-title {
            font-size: 1.5em;
            font-weight: 600;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }
        
        .video-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .video-selector label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .video-dropdown {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.9em;
            min-width: 200px;
            cursor: pointer;
        }
        
        .video-dropdown option {
            background: #2a5298;
            color: white;
        }
        
        .video-dropdown:focus {
            outline: none;
            border-color: rgba(255,255,255,0.6);
            box-shadow: 0 0 0 2px rgba(255,255,255,0.2);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            padding: 20px;
            height: 100%;
        }
        
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .video-info { 
            background: linear-gradient(135deg, #e3f2fd, #bbdefb); 
            padding: 20px; 
            border-radius: 10px; 
            border-left: 5px solid #2196f3;
            font-size: 1.1em;
        }
        
        .image-container { 
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 10px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }
        
        #video-canvas { 
            max-width: 100%; 
            max-height: 100%;
            cursor: crosshair; 
            border: 3px solid #ddd; 
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .coordinate-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
            pointer-events: none;
            z-index: 1000;
            transform: translate(10px, -30px);
            white-space: nowrap;
            display: none;
        }
        
        .coordinate-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 8px;
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid rgba(0, 0, 0, 0.8);
        }
        
        .instructions-panel {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #9c27b0;
            margin-bottom: 15px;
        }
        
        .instructions-panel h3 {
            margin: 0 0 15px 0;
            color: #6a1b9a;
            font-size: 1.2em;
        }
        
        .instructions-list {
            margin: 0;
            padding-left: 20px;
            color: #4a148c;
        }
        
        .instructions-list li {
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .step-highlight {
            background: rgba(156, 39, 176, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .status-panel { 
            background: linear-gradient(135deg, #fff3e0, #ffe0b2); 
            padding: 20px; 
            border-radius: 10px; 
            border-left: 5px solid #ff9800;
        }
        
        .status-panel h3 {
            margin: 0 0 15px 0;
            color: #e65100;
            font-size: 1.2em;
        }
        
        #current-status {
            font-size: 1.1em;
            line-height: 1.4;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
        }
        
        .points-list { 
            flex: 1;
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 10px; 
            font-family: 'Courier New', monospace; 
            font-size: 13px;
            overflow-y: auto;
            border: 2px solid #e9ecef;
            max-height: 300px;
        }
        
        .points-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .points-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .points-list::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .controls { 
            background: #f8f9fa;
            padding: 20px; 
            text-align: center;
            border-top: 1px solid #e9ecef;
        }
        
        .button-group {
            display: inline-flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        button { 
            background: linear-gradient(45deg, #2196f3, #21cbf3); 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 25px; 
            cursor: pointer; 
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }
        
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }
        
        button:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
            transform: none;
            box-shadow: none;
        }
        
        .skip-btn { 
            background: linear-gradient(45deg, #ff9800, #ffc107); 
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
        }
        
        .skip-btn:hover { 
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
        }
        
        .reset-btn {
            background: linear-gradient(45deg, #f44336, #ff5722);
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }
        
        .reset-btn:hover {
            box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
        }
        
        .save-btn {
            background: linear-gradient(45deg, #4caf50, #8bc34a);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        .save-btn:hover {
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr auto;
            }
            
            .right-panel {
                order: -1;
            }
            
            .image-container {
                min-height: 400px;
            }
        }
        
        @media (max-width: 768px) {
            body { padding: 5px; }
            .container { border-radius: 10px; }
            .main-content { padding: 15px; gap: 15px; }
            .app-bar { flex-direction: column; gap: 10px; text-align: center; }
            .app-bar-title { font-size: 1.3em; }
            .app-bar > div { flex-direction: column; gap: 10px; }
            .video-selector { justify-content: center; }
            .video-dropdown { min-width: 250px; }
            .button-group { flex-direction: column; align-items: center; }
            button { width: 200px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="app-bar">
            <div class="app-bar-title">üéØ Pixel Coordinate Collector</div>
            <div style="display: flex; gap: 20px; align-items: center;">
                <div class="video-selector">
                    <label for="video-select">üìÅ ÎπÑÎîîÏò§ ÏÑ†ÌÉù:</label>
                    <select id="video-select" class="video-dropdown" onchange="selectVideo()">
                        <option value="">Î°úÎî© Ï§ë...</option>
                    </select>
                </div>
                <div class="video-selector">
                    <label for="guide-select">üéØ Í∞ÄÏù¥Îìú ÏÑ†ÌÉù:</label>
                    <select id="guide-select" class="video-dropdown" onchange="selectGuide()">
                        <option value="guide1">Guide 1</option>
                        <option value="guide2">Guide 2</option>
                        <option value="guide3">Guide 3</option>
                        <option value="guide4">Guide 4</option>
                        <option value="guide5">Guide 5</option>
                        <option value="guide6">Guide 6</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="video-info">
            <div id="video-info">üé¨ ÎπÑÎîîÏò§ Î°úÎî© Ï§ë...</div>
        </div>
        
        <div class="main-content">
            <div class="left-panel">
                <div class="image-container">
                    <canvas id="video-canvas"></canvas>
                    <div id="coordinate-tooltip" class="coordinate-tooltip"></div>
                </div>
            </div>
            
            <div class="right-panel">
                <div class="instructions-panel">
                    <h3>üìù ÏÇ¨Ïö© Î∞©Î≤ï</h3>
                    <ol class="instructions-list">
                        <li><span class="step-highlight">üñ±Ô∏è ÌÅ¥Î¶≠</span>: ÏõêÌïòÎäî ÏúÑÏπòÎ•º ÎßàÏö∞Ïä§Î°ú ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî</li>
                        <li><span class="step-highlight">üìå Ï∂îÍ∞Ä</span>: ÌïÑÏöîÌïú ÎßåÌÅº Ï†êÏùÑ Ï∂îÍ∞ÄÌï† Ïàò ÏûàÏäµÎãàÎã§</li>
                        <li><span class="step-highlight">üíæ Ï†ÄÏû•</span>: ÏôÑÎ£åÎêòÎ©¥ Ï†ÄÏû• Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî</li>
                        <li><span class="step-highlight">üîÑ Î¶¨ÏÖã</span>: Îã§Ïãú ÏãúÏûëÌïòÎ†§Î©¥ Î¶¨ÏÖã Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî</li>
                    </ol>
                    <div style="background: rgba(76, 175, 80, 0.1); padding: 8px; border-radius: 4px; margin-top: 10px; font-size: 0.9em;">
                        üí° <strong>ÌåÅ:</strong> ÎßàÏö∞Ïä§Î•º ÏõÄÏßÅÏù¥Î©¥ ÌòÑÏû¨ Ï¢åÌëúÍ∞Ä ÌëúÏãúÎê©ÎãàÎã§
                    </div>
                    <div style="background: rgba(33, 150, 243, 0.1); padding: 8px; border-radius: 4px; margin-top: 8px; font-size: 0.9em;">
                        ‚å®Ô∏è <strong>Îã®Ï∂ïÌÇ§:</strong> 
                        <span style="font-family: monospace; background: rgba(255,255,255,0.8); padding: 2px 4px; border-radius: 3px; margin: 0 2px;">Ctrl+Z</span> ÎêòÎèåÎ¶¨Í∏∞ | 
                        <span style="font-family: monospace; background: rgba(255,255,255,0.8); padding: 2px 4px; border-radius: 3px; margin: 0 2px;">Ctrl+Y</span> Îã§Ïãú Ïã§Ìñâ
                    </div>
                </div>
                
                <div class="status-panel">
                    <h3>üìä ÌòÑÏû¨ ÏÉÅÌÉú:</h3>
                    <div id="current-status">ÌÅ¥Î¶≠ ÎåÄÍ∏∞ Ï§ë...</div>
                </div>
                
                <div class="points-list" id="points-list">
                    <strong>üìå ÌÅ¥Î¶≠Îêú Ï¢åÌëú:</strong><br>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <div class="button-group">
                <button onclick="undoLastPoint()" id="undo-btn" title="Ctrl+Z">‚Ü∂ ÎêòÎèåÎ¶¨Í∏∞</button>
                <button onclick="redoLastPoint()" id="redo-btn" title="Ctrl+Y">‚Ü∑ Îã§Ïãú Ïã§Ìñâ</button>
                <button onclick="resetPoints()" class="reset-btn">üîÑ Î¶¨ÏÖã</button>
                <button onclick="skipVideo()" class="skip-btn">‚è≠Ô∏è Í±¥ÎÑàÎõ∞Í∏∞</button>
                <button onclick="savePixelPoints()" id="save-btn" class="save-btn">üíæ Ï†ÄÏû•</button>
            </div>
        </div>
    </div>

    <script>
        let pixelPoints = [];
        let undoStack = [];
        let redoStack = [];
        let currentVideoInfo = null;
        let canvas = document.getElementById('video-canvas');
        let ctx = canvas.getContext('2d');
        let videoImage = new Image();

        window.onload = function() {
            loadVideoList();
            loadVideoInfo();
            updateStatus();
            loadGuideSelection();
            
            // ÌÇ§Î≥¥Îìú Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
            document.addEventListener('keydown', function(event) {
                if (event.ctrlKey) {
                    if (event.key === 'z' || event.key === 'Z') {
                        event.preventDefault();
                        undoLastPoint();
                    } else if (event.key === 'y' || event.key === 'Y') {
                        event.preventDefault();
                        redoLastPoint();
                    }
                }
            });
        };

        async function loadVideoInfo() {
            try {
                const response = await fetch('/api/video_info');
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                currentVideoInfo = data;
                
                document.getElementById('video-info').innerHTML = 
                    `<div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <div>
                            <strong>üé¨ ${data.video_name}</strong>
                        </div>
                        <div style="flex: 1;"></div>
                        <div style="background: rgba(255,255,255,0.8); padding: 5px 10px; border-radius: 15px; font-size: 0.9em;">
                            üìä ÏßÑÌñâ: ${data.index}/${data.total}
                        </div>
                        <div style="padding: 3px 8px; border-radius: 12px; font-size: 0.85em; ${data.is_processed ? 'background: #4caf50; color: white;' : 'background: #ff9800; color: white;'}">
                            ${data.is_processed ? '‚úÖ Ï≤òÎ¶¨ÏôÑÎ£å' : '‚è≥ ÎåÄÍ∏∞Ï§ë'}
                        </div>
                    </div>`;
                
                videoImage.onload = function() {
                    canvas.width = this.width;
                    canvas.height = this.height;
                    drawCanvas();
                };
                videoImage.src = data.image_data;
                
            } catch (error) {
                console.error('Error loading video info:', error);
                alert('ÎπÑÎîîÏò§ Ï†ïÎ≥¥ Î°úÎî© Ïã§Ìå®');
            }
        }

        function drawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(videoImage, 0, 0);
            
            // ÌÅ¥Î¶≠Îêú Ìè¨Ïù∏Ìä∏Îì§ Í∑∏Î¶¨Í∏∞
            pixelPoints.forEach((point, index) => {
                ctx.fillStyle = '#FF0000';
                ctx.beginPath();
                ctx.arc(point[0], point[1], 5, 0, 2 * Math.PI);
                ctx.fill();
                
                ctx.fillStyle = 'white';
                ctx.font = '12px Arial';
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 2;
                ctx.strokeText(index + 1, point[0] + 8, point[1] - 8);
                ctx.fillText(index + 1, point[0] + 8, point[1] - 8);
            });
        }

        canvas.onclick = function(event) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const x = Math.round((event.clientX - rect.left) * scaleX);
            const y = Math.round((event.clientY - rect.top) * scaleY);
            
            // ÌòÑÏû¨ ÏÉÅÌÉúÎ•º undo Ïä§ÌÉùÏóê Ï†ÄÏû•
            undoStack.push([...pixelPoints]);
            // ÏÉàÎ°úÏö¥ Ïï°ÏÖòÏù¥ÎØÄÎ°ú redo Ïä§ÌÉù Ï¥àÍ∏∞Ìôî
            redoStack = [];
            
            pixelPoints.push([x, y]);
            console.log(`ÌÅ¥Î¶≠ ${pixelPoints.length}: (${x}, ${y})`);
            
            drawCanvas();
            updateUI();
        };

        // ÎßàÏö∞Ïä§ Ïù¥Îèô Ïãú Ï¢åÌëú ÌëúÏãú
        canvas.onmousemove = function(event) {
            const tooltip = document.getElementById('coordinate-tooltip');
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const x = Math.round((event.clientX - rect.left) * scaleX);
            const y = Math.round((event.clientY - rect.top) * scaleY);
            
            tooltip.textContent = `(${x}, ${y})`;
            tooltip.style.left = event.clientX + 'px';
            tooltip.style.top = event.clientY + 'px';
            tooltip.style.display = 'block';
        };

        canvas.onmouseleave = function() {
            document.getElementById('coordinate-tooltip').style.display = 'none';
        };

        canvas.onmouseenter = function() {
            document.getElementById('coordinate-tooltip').style.display = 'block';
        };

        function updateUI() {
            updateStatus();
            updatePointsList();
        }

        function updateStatus() {
            const statusElement = document.getElementById('current-status');
            
            // Undo/Redo ÏÉÅÌÉú Ï†ïÎ≥¥
            const undoAvailable = undoStack.length > 0;
            const redoAvailable = redoStack.length > 0;
            const undoText = undoAvailable ? '‚úÖ' : '‚ùå';
            const redoText = redoAvailable ? '‚úÖ' : '‚ùå';
            
            // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');
            if (undoBtn) undoBtn.disabled = !undoAvailable;
            if (redoBtn) redoBtn.disabled = !redoAvailable;
            
            if (pixelPoints.length === 0) {
                statusElement.innerHTML = `
                    <div style="background: rgba(255,255,255,0.9); padding: 8px; border-radius: 6px;">
                        üñ±Ô∏è <strong>ÌÅ¥Î¶≠ ÎåÄÍ∏∞ Ï§ë</strong><br>
                        <span style="font-size: 0.9em; color: #666;">ÏõêÌïòÎäî ÏúÑÏπòÎ•º ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî</span>
                        <div style="margin-top: 8px; font-size: 0.8em; color: #888; border-top: 1px solid #eee; padding-top: 5px;">
                            ${undoText} Ctrl+Z ÎêòÎèåÎ¶¨Í∏∞ | ${redoText} Ctrl+Y Îã§Ïãú Ïã§Ìñâ
                        </div>
                    </div>
                `;
            } else {
                statusElement.innerHTML = `
                    <div style="background: rgba(76, 175, 80, 0.1); padding: 8px; border-radius: 6px;">
                        üìå <strong>${pixelPoints.length}Í∞ú Ï¢åÌëú ÏàòÏßëÎê®</strong><br>
                        <span style="font-size: 0.9em; color: #333;">Îçî Ï∂îÍ∞ÄÌïòÍ±∞ÎÇò Ï†ÄÏû•ÌïòÏÑ∏Ïöî</span>
                        <div style="margin-top: 8px; font-size: 0.8em; color: #666; border-top: 1px solid #ddd; padding-top: 5px;">
                            ${undoText} Ctrl+Z ÎêòÎèåÎ¶¨Í∏∞ | ${redoText} Ctrl+Y Îã§Ïãú Ïã§Ìñâ
                        </div>
                    </div>
                `;
            }
        }

        function updatePointsList() {
            const listElement = document.getElementById('points-list');
            let content = '<strong>üìå ÌÅ¥Î¶≠Îêú Ï¢åÌëú:</strong><br><br>';
            
            pixelPoints.forEach((point, index) => {
                content += `üî¥ ${index + 1}Î≤à: (${point[0]}, ${point[1]})<br>`;
            });
            
            if (pixelPoints.length === 0) {
                content += '<span style="color: #666; font-style: italic;">ÏïÑÏßÅ ÌÅ¥Î¶≠Îêú Ï¢åÌëúÍ∞Ä ÏóÜÏäµÎãàÎã§.</span>';
            }
            
            listElement.innerHTML = content;
            listElement.scrollTop = listElement.scrollHeight;
        }

        function undoLastPoint() {
            if (undoStack.length > 0) {
                // ÌòÑÏû¨ ÏÉÅÌÉúÎ•º redo Ïä§ÌÉùÏóê Ï†ÄÏû•
                redoStack.push([...pixelPoints]);
                // Ïù¥Ï†Ñ ÏÉÅÌÉúÎ°ú Î≥µÏõê
                pixelPoints = undoStack.pop();
                
                console.log(`Undo: ${pixelPoints.length}Í∞ú Ï¢åÌëúÎ°ú Î≥µÏõê`);
                drawCanvas();
                updateUI();
            } else {
                console.log('Undo: ÎêòÎèåÎ¶¥ Ïï°ÏÖòÏù¥ ÏóÜÏäµÎãàÎã§');
            }
        }

        function redoLastPoint() {
            if (redoStack.length > 0) {
                // ÌòÑÏû¨ ÏÉÅÌÉúÎ•º undo Ïä§ÌÉùÏóê Ï†ÄÏû•
                undoStack.push([...pixelPoints]);
                // Îã§Ïãú Ïã§Ìñâ ÏÉÅÌÉúÎ°ú Î≥µÏõê
                pixelPoints = redoStack.pop();
                
                console.log(`Redo: ${pixelPoints.length}Í∞ú Ï¢åÌëúÎ°ú Î≥µÏõê`);
                drawCanvas();
                updateUI();
            } else {
                console.log('Redo: Îã§Ïãú Ïã§ÌñâÌï† Ïï°ÏÖòÏù¥ ÏóÜÏäµÎãàÎã§');
            }
        }

        function resetPoints() {
            console.log('Reset points called');
            // Î¶¨ÏÖãÎèÑ ÎêòÎèåÎ¶¥ Ïàò ÏûàÎèÑÎ°ù ÌòÑÏû¨ ÏÉÅÌÉúÎ•º undo Ïä§ÌÉùÏóê Ï†ÄÏû•
            if (pixelPoints.length > 0) {
                undoStack.push([...pixelPoints]);
                redoStack = [];
            }
            pixelPoints = [];
            drawCanvas();
            updateUI();
        }

        async function savePixelPoints() {
            if (pixelPoints.length === 0) {
                alert('ÏµúÏÜå 1Í∞ú Ïù¥ÏÉÅÏùò Ï¢åÌëúÎ•º ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            try {
                const response = await fetch('/api/save_pixel_points', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        pixel_points: pixelPoints
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ ${pixelPoints.length}Í∞ú Ï¢åÌëú Ï†ÄÏû• ÏôÑÎ£å!`);
                    loadVideoList();
                    nextVideo();
                } else {
                    alert('‚ùå Ï†ÄÏû• Ïã§Ìå®: ' + data.error);
                }
                
            } catch (error) {
                console.error('Error saving pixel points:', error);
                alert('Ï†ÄÏû• Ï§ë Ïò§Î•ò Î∞úÏÉù');
            }
        }

        async function skipVideo() {
            if (confirm('ÌòÑÏû¨ ÎπÑÎîîÏò§Î•º Í±¥ÎÑàÎõ∞ÏãúÍ≤†ÏäµÎãàÍπå?')) {
                pixelPoints = [];
                undoStack = [];
                redoStack = [];
                await fetch('/api/skip_video');
                loadVideoList();
                nextVideo();
            }
        }

        async function nextVideo() {
            pixelPoints = [];
            undoStack = [];
            redoStack = [];
            await fetch('/api/next_video');
            loadVideoList();
            await loadVideoInfo();
            updateUI();
        }

        async function loadVideoList() {
            try {
                const response = await fetch('/api/video_list');
                const data = await response.json();
                
                const dropdown = document.getElementById('video-select');
                dropdown.innerHTML = '';
                
                data.videos.forEach((video, index) => {
                    const option = document.createElement('option');
                    option.value = video.index;
                    const statusIcon = video.is_processed ? '‚úÖ' : '‚è≥';
                    option.textContent = `${statusIcon} ${video.name}`;
                    
                    if (video.index === data.current_index) {
                        option.selected = true;
                    }
                    
                    dropdown.appendChild(option);
                });
                
            } catch (error) {
                console.error('ÎπÑÎîîÏò§ Î™©Î°ù Î°úÎî© Ïã§Ìå®:', error);
            }
        }

        async function selectVideo() {
            const dropdown = document.getElementById('video-select');
            const selectedIndex = dropdown.value;
            
            if (selectedIndex === '') return;
            
            try {
                pixelPoints = [];
                undoStack = [];
                redoStack = [];
                const response = await fetch(`/api/select_video/${selectedIndex}`);
                const data = await response.json();
                
                if (data.success) {
                    await loadVideoInfo();
                    updateUI();
                } else {
                    alert('ÎπÑÎîîÏò§ ÏÑ†ÌÉù Ïã§Ìå®: ' + data.error);
                }
                
            } catch (error) {
                console.error('ÎπÑÎîîÏò§ ÏÑ†ÌÉù Ïã§Ìå®:', error);
                alert('ÎπÑÎîîÏò§ ÏÑ†ÌÉù Ï§ë Ïò§Î•ò Î∞úÏÉù');
            }
        }

        async function selectGuide() {
            const dropdown = document.getElementById('guide-select');
            const selectedGuide = dropdown.value;
            
            if (selectedGuide === '') return;
            
            try {
                const response = await fetch(`/api/select_guide/${selectedGuide}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    await loadVideoInfo();
                    updateUI();
                } else {
                    alert('Í∞ÄÏù¥Îìú ÏÑ†ÌÉù Ïã§Ìå®: ' + data.error);
                }
                
            } catch (error) {
                console.error('Í∞ÄÏù¥Îìú ÏÑ†ÌÉù Ïã§Ìå®:', error);
                alert('Í∞ÄÏù¥Îìú ÏÑ†ÌÉù Ï§ë Ïò§Î•ò Î∞úÏÉù');
            }
        }

        async function loadGuideSelection() {
            try {
                const response = await fetch('/api/current_guide');
                const data = await response.json();
                
                if (data.success) {
                    const dropdown = document.getElementById('guide-select');
                    dropdown.value = data.current_guide;
                }
            } catch (error) {
                console.error('Í∞ÄÏù¥Îìú ÏÑ†ÌÉù Î°úÎî© Ïã§Ìå®:', error);
            }
        }
    </script>
</body>
</html>
'''

@app.route('/')
def index():
    """Î©îÏù∏ ÌéòÏù¥ÏßÄ"""
    return render_template_string(HTML_TEMPLATE)

@app.route('/api/video_info')
def get_video_info():
    """ÌòÑÏû¨ ÎπÑÎîîÏò§ Ï†ïÎ≥¥ Î∞òÌôò"""
    if pixel_collector.current_video_index >= len(pixel_collector.current_video_files):
        return jsonify({'error': 'Î™®Îì† ÎπÑÎîîÏò§ Ï≤òÎ¶¨ ÏôÑÎ£å!'})
    
    video_path = pixel_collector.current_video_files[pixel_collector.current_video_index]
    video_name = video_path.stem
    
    # Ïù¥ÎØ∏ Ï≤òÎ¶¨Îêú ÌååÏùºÏù∏ÏßÄ ÌôïÏù∏
    pixel_file = pixel_collector.output_dir / f"{video_name}_pixel_points.json"
    is_processed = pixel_file.exists()
    
    # ÎπÑÎîîÏò§ Ï§ëÍ∞Ñ ÌîÑÎ†àÏûÑÏùÑ base64Î°ú Ïù∏ÏΩîÎî©
    cap = cv2.VideoCapture(str(video_path))
    if not cap.isOpened():
        return jsonify({'error': 'ÎπÑÎîîÏò§ ÌååÏùºÏùÑ Ïó¥ Ïàò ÏóÜÏäµÎãàÎã§.'})
    
    # Ï†ÑÏ≤¥ ÌîÑÎ†àÏûÑ Ïàò Íµ¨ÌïòÍ∏∞
    total_frames = int(cap.get(cv2.CAP_PROP_FRAME_COUNT))
    
    # Ï§ëÍ∞Ñ ÌîÑÎ†àÏûÑ ÏúÑÏπòÎ°ú Ïù¥Îèô
    middle_frame = total_frames // 2
    cap.set(cv2.CAP_PROP_POS_FRAMES, middle_frame)
    
    ret, frame = cap.read()
    cap.release()
    
    if not ret:
        return jsonify({'error': 'ÎπÑÎîîÏò§ ÌîÑÎ†àÏûÑÏùÑ ÏùΩÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.'})
    
    # Í∞ÄÏù¥Îìú Ïù¥ÎØ∏ÏßÄ Ïò§Î≤ÑÎ†àÏù¥
    guide_path = pixel_collector.get_guide_path()
    if os.path.exists(guide_path):
        try:
            # Í∞ÄÏù¥Îìú Ïù¥ÎØ∏ÏßÄ Î°úÎìú
            guide_img = cv2.imread(guide_path, cv2.IMREAD_UNCHANGED)
            
            if guide_img is not None:
                # Í∞ÄÏù¥Îìú Ïù¥ÎØ∏ÏßÄÎ•º ÎπÑÎîîÏò§ ÌîÑÎ†àÏûÑ ÌÅ¨Í∏∞Ïóê ÎßûÍ≤å Î¶¨ÏÇ¨Ïù¥Ï¶à
                frame_height, frame_width = frame.shape[:2]
                guide_resized = cv2.resize(guide_img, (frame_width, frame_height))
                
                # ÏïåÌåå Ï±ÑÎÑêÏù¥ ÏûàÎäî Í≤ΩÏö∞ (PNG Ìà¨Î™ÖÎèÑ Ï≤òÎ¶¨)
                if guide_resized.shape[2] == 4:
                    # ÏïåÌåå Ï±ÑÎÑê Î∂ÑÎ¶¨
                    alpha_channel = guide_resized[:, :, 3] / 255.0
                    guide_rgb = guide_resized[:, :, :3]
                    
                    # ÏïåÌåå Î∏îÎ†åÎî©
                    for c in range(3):
                        frame[:, :, c] = frame[:, :, c] * (1 - alpha_channel) + guide_rgb[:, :, c] * alpha_channel
                else:
                    # ÏïåÌåå Ï±ÑÎÑêÏù¥ ÏóÜÎäî Í≤ΩÏö∞ 50% Ìà¨Î™ÖÎèÑÎ°ú Ïò§Î≤ÑÎ†àÏù¥
                    frame = cv2.addWeighted(frame, 0.7, guide_resized, 0.3, 0)
                
                print(f"‚úÖ Í∞ÄÏù¥Îìú Ïù¥ÎØ∏ÏßÄ Ïò§Î≤ÑÎ†àÏù¥ ÏôÑÎ£å: {guide_path}")
        except Exception as e:
            print(f"‚ö†Ô∏è Í∞ÄÏù¥Îìú Ïù¥ÎØ∏ÏßÄ Ïò§Î≤ÑÎ†àÏù¥ Ïã§Ìå®: {e}")
    else:
        print(f"‚ö†Ô∏è Í∞ÄÏù¥Îìú Ïù¥ÎØ∏ÏßÄÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå: {guide_path}")
    
    # base64 Ïù∏ÏΩîÎî©
    _, buffer = cv2.imencode('.jpg', frame)
    img_str = base64.b64encode(buffer).decode()
    
    return jsonify({
        'video_path': str(video_path),
        'video_name': video_name,
        'index': pixel_collector.current_video_index + 1,
        'total': len(pixel_collector.current_video_files),
        'is_processed': is_processed,
        'image_data': f"data:image/jpeg;base64,{img_str}"
    })

@app.route('/api/save_pixel_points', methods=['POST'])
def save_pixel_points():
    """ÌîΩÏÖÄ Ï¢åÌëú Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•"""
    data = request.get_json()
    
    if not data or 'pixel_points' not in data or len(data['pixel_points']) == 0:
        return jsonify({'error': 'ÏµúÏÜå 1Í∞ú Ïù¥ÏÉÅÏùò Ï¢åÌëúÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.'})
    
    video_path = pixel_collector.current_video_files[pixel_collector.current_video_index]
    video_name = video_path.stem
    
    try:
        # Í≤∞Í≥º Ï†ÄÏû•
        pixel_file_json = pixel_collector.output_dir / f"{video_name}_pixel_points.json"
        pixel_file_npy = pixel_collector.output_dir / f"{video_name}_pixel_points.npy"
        
        # JSON ÌòïÌÉúÎ°ú Ï†ÄÏû• (Í∞ÄÎèÖÏÑ±)
        save_data = {
            'video_name': video_name,
            'video_path': str(video_path),
            'pixel_points': data['pixel_points'],
            'point_count': len(data['pixel_points']),
            'description': 'Ïõπ ÎèÑÍµ¨Î°ú ÏàòÏßëÎêú ÌîΩÏÖÄ Ï¢åÌëú'
        }
        
        with open(pixel_file_json, 'w', encoding='utf-8') as f:
            json.dump(save_data, f, indent=2, ensure_ascii=False)
        
        # NumPy ÌòïÌÉúÎ°úÎèÑ Ï†ÄÏû• (data_preprocessing.pyÏôÄ Ìò∏Ìôò)
        pixel_points_array = np.array(data['pixel_points'], dtype='float32')
        np.save(pixel_file_npy, pixel_points_array)
        
        return jsonify({
            'success': True, 
            'message': f'{len(data["pixel_points"])}Í∞ú Ï¢åÌëú Ï†ÄÏû• ÏôÑÎ£å',
            'saved_files': [str(pixel_file_json), str(pixel_file_npy)]
        })
        
    except Exception as e:
        return jsonify({'error': f'Ï†ÄÏû• Ï§ë Ïò§Î•ò: {e}'})

@app.route('/api/next_video')
def next_video():
    """Îã§Ïùå ÎπÑÎîîÏò§Î°ú Ïù¥Îèô"""
    pixel_collector.current_video_index += 1
    return jsonify({'success': True})

@app.route('/api/skip_video')
def skip_video():
    """ÌòÑÏû¨ ÎπÑÎîîÏò§ Í±¥ÎÑàÎõ∞Í∏∞"""
    pixel_collector.current_video_index += 1
    return jsonify({'success': True})

@app.route('/api/video_list')
def get_video_list():
    """ÎπÑÎîîÏò§ ÌååÏùº Î™©Î°ù Î∞òÌôò"""
    video_list = []
    for i, video_path in enumerate(pixel_collector.current_video_files):
        video_name = video_path.stem
        pixel_file = pixel_collector.output_dir / f"{video_name}_pixel_points.json"
        is_processed = pixel_file.exists()
        
        video_list.append({
            'index': i,
            'name': video_name,
            'path': str(video_path),
            'is_processed': is_processed
        })
    
    return jsonify({
        'videos': video_list,
        'current_index': pixel_collector.current_video_index,
        'total': len(pixel_collector.current_video_files)
    })

@app.route('/api/select_video/<int:video_index>')
def select_video(video_index):
    """ÌäπÏ†ï ÎπÑÎîîÏò§ ÏÑ†ÌÉù"""
    if 0 <= video_index < len(pixel_collector.current_video_files):
        pixel_collector.current_video_index = video_index
        return jsonify({'success': True, 'message': f'ÎπÑÎîîÏò§ {video_index + 1} ÏÑ†ÌÉùÎê®'})
    else:
        return jsonify({'error': 'Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÎπÑÎîîÏò§ Ïù∏Îç±Ïä§'})

@app.route('/api/select_guide/<string:guide_name>', methods=['POST'])
def select_guide(guide_name):
    """ÌäπÏ†ï Í∞ÄÏù¥Îìú ÏÑ†ÌÉù"""
    if guide_name in ['guide1', 'guide2', 'guide3', 'guide4', 'guide5', 'guide6']:
        pixel_collector.current_guide = guide_name
        return jsonify({'success': True, 'message': f'{guide_name} ÏÑ†ÌÉùÎê®'})
    else:
        return jsonify({'error': 'Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Í∞ÄÏù¥Îìú Ïù¥Î¶Ñ'})

@app.route('/api/current_guide')
def get_current_guide():
    """ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Í∞ÄÏù¥Îìú Î∞òÌôò"""
    return jsonify({'success': True, 'current_guide': pixel_collector.current_guide})

def main():
    parser = argparse.ArgumentParser(description='Ïõπ Í∏∞Î∞ò ÌîΩÏÖÄ Ï¢åÌëú ÏàòÏßë ÎèÑÍµ¨')
    parser.add_argument('--video_dir', type=str, default='./data/video',
                       help='ÎπÑÎîîÏò§ ÌååÏùºÏù¥ ÏûàÎäî ÎîîÎ†âÌÜ†Î¶¨')
    parser.add_argument('--output_dir', type=str, default='./data/pixel_points',
                       help='ÌîΩÏÖÄ Ï¢åÌëú Í≤∞Í≥º Ï†ÄÏû• ÎîîÎ†âÌÜ†Î¶¨')  
    parser.add_argument('--port', type=int, default=5001,
                       help='Ïõπ ÏÑúÎ≤Ñ Ìè¨Ìä∏ (Í∏∞Î≥∏Í∞í: 5001)')
    parser.add_argument('--host', type=str, default='0.0.0.0',
                       help='Ïõπ ÏÑúÎ≤Ñ Ìò∏Ïä§Ìä∏ (Í∏∞Î≥∏Í∞í: 0.0.0.0)')
    
    args = parser.parse_args()
    
    print("üéØ Pixel Coordinate Collector")
    print("=" * 50)
    print(f"üìÅ ÎπÑÎîîÏò§ ÎîîÎ†âÌÜ†Î¶¨: {args.video_dir}")
    print(f"üíæ Ï∂úÎ†• ÎîîÎ†âÌÜ†Î¶¨: {args.output_dir}")
    print(f"üåê ÏÑúÎ≤Ñ: http://localhost:{args.port}")
    print("=" * 50)
    
    # ÏÑ§Ï†ï Ï¥àÍ∏∞Ìôî
    global pixel_collector
    pixel_collector = PixelCoordinateCollector(output_dir=args.output_dir)
    
    # ÎπÑÎîîÏò§ ÌååÏùº Ï∞æÍ∏∞
    video_count = pixel_collector.find_video_files(args.video_dir)
    print(f"üé¨ Ï¥ù {video_count}Í∞úÏùò ÎπÑÎîîÏò§ ÌååÏùº Î∞úÍ≤¨")
    
    if video_count == 0:
        print("‚ùå ÎπÑÎîîÏò§ ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.")
        return
    
    print(f"\nüöÄ Ïõπ ÏÑúÎ≤Ñ ÏãúÏûë...")
    print(f"üåê Î∏åÎùºÏö∞Ï†ÄÏóêÏÑú http://localhost:{args.port} Ï†ëÏÜç")
    print(f"üîó SSH Ìè¨Ìä∏Ìè¨ÏõåÎî©: ssh -L {args.port}:localhost:{args.port} user@server")
    
    # Flask Ïï± Ïã§Ìñâ
    app.run(host=args.host, port=args.port, debug=False)

if __name__ == "__main__":
    main() 